<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Speech Recognition</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.webrtc-experiment.com/RecordRTC.js"></script>
    <style>
        .container {
            max-width: 600px;
            margin-top: 50px;
        }

        .recording-indicator {
            position: relative;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #ff5b5b;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .recording-indicator.active {
            opacity: 1;
            animation: shimmer 2s infinite;
        }

        .recording-indicator i {
            font-size: 32px;
            color: #fff;
        }

        @keyframes shimmer {
            0% {
                background-position: -200px 0;
            }
            100% {
                background-position: 200px 0;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <h1 class="text-center">Speech Recognition</h1>

    <div class="input-group mb-3">
        <input type="text" class="form-control" id="speech_text" placeholder="Enter your speech">
        <span class="input-group-text" onclick="record()">
            <i class="bi bi-mic"></i>
        </span>
    </div>

    <div class="recording-indicator" id="recordingIndicator">
        <i class="bi bi-mic-fill"></i>
    </div>

    <div class="text-center" id="stop_button" style="display: none">
        <button class="btn btn-danger" onclick="stop()">Stop</button>
    </div>

    <div id="downloadLink" class="text-center mt-3"></div>
</div>

<script>
    let recordedBlob;
    const recordingIndicator = document.getElementById('recordingIndicator');

    function record() {
        navigator.mediaDevices.getUserMedia({audio: true})
            .then(function (stream) {
                // Use the stream to initialize the recorder
                let recorder = RecordRTC(stream, {
                    type: 'audio' // Specify the type as 'audio'
                });
                window.recorder = recorder
                // Start recording
                recorder.startRecording();

                // Show the recording indicator
                recordingIndicator.classList.add('active');
                document.querySelector("#stop_button").style.display=""
            })
            .catch(function (error) {
                console.error('Error accessing microphone:', error);
            });
    }

    function stop() {
        window.recorder.stopRecording(function () {
            // Get the recorded audio as a Blob
            recordedBlob = recorder.getBlob();

            // Hide the recording indicator
            recordingIndicator.classList.remove('active');

            upload_audio_file( recordedBlob )

            // You can upload the blob to your server or process it further
            // For example, you can create a download link for the recorded audio

            // let url = URL.createObjectURL(recordedBlob);
            // let downloadLink = document.createElement('a');
            // downloadLink.href = url;
            // downloadLink.download = 'recorded_audio.wav';
            // downloadLink.innerHTML = 'Download Recorded Audio';
            // document.getElementById('downloadLink').innerHTML = '';
            // document.getElementById('downloadLink').appendChild(downloadLink);
            // document.querySelector("#stop_button").style.display="none"
        });

    }

    function upload_audio_file(recordedBlob) {
// Create a FormData object and append the recorded Blob file
        const formData = new FormData();
        formData.append('audio', recordedBlob, 'recorded_audio.wav');

// Send a POST request to the server with the recorded audio file
        fetch('https://speech-to-text.tangsaihong.repl.co/upload', {
            method: 'POST',
            mode: 'cors',
            body: formData
        })
            .then(function(response) {
                if (response.ok) {
                    return response.text()
                } else {
                    console.error('Error uploading file');
                }
            })
            .then(function(text) {
                document.querySelector("#speech_text").value = text ;
                console.log('Response text:', text); // Log the response text
            })
            .catch(function(error) {
                console.error('Error uploading file:', error);
            });

    }
</script>
</body>
</html>
