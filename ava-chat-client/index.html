<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <link rel="icon" type="image/svg+xml" href="/robot.png" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0 ,maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,viewport-fit=cover"
        />
        <!-- <meta http-equiv="Feature-Policy" content="microphone 'self'" /> -->
        <title>智能客服</title>
        <!-- <script src="//www.webrtc-experiment.com/RecordRTC.js"></script> -->
        <!-- <script src="https://cdn.webrtc-experiment.com/RecordRTC.js"></script> -->
        <script src="/RecordRTC.js"></script>
        <style>
            body,
            html {
                margin: 0;
                padding: 0;
                height: 100%;
                background-color: white;
            }
            #loading-container {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background-color: white;
                z-index: 99999;
                display: flex;
                justify-content: center;
                align-items: center;
                flex-direction: column;
                transition: opacity 0.5s ease-in-out;
            }
            .loading-content {
                text-align: center;
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            .spinner {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                border: 4px solid #f3f3f3;
                border-top: 4px solid #3498db;
                animation: spin 1s linear infinite;
                margin: 0 auto 20px;
            }
            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }
            .loading-text {
                font-size: 16px;
                color: #333;
                position: relative;
                width: 100px;
                text-align: center;
            }
        </style>
    </head>
    <body>
        <div id="loading-container">
            <div class="loading-content">
                <div class="spinner"></div>
                <div class="loading-text">初始化中</div>
            </div>
        </div>
        <div id="app"></div>
        <div id="global-teleport-target"></div>
        <!-- <script type="module" src="/src/main.js"></script> -->
        <script type="module">
            import axios from "./src/global/axios.js";

            // 用async包是為了讓docker能build成功
            (async () => {
                try {
                    // 必須等待 initial API 回應後才能載入 main.js
                    const initResponse = await axios.get("/initial");
                    await import("/src/main.js");

                    // 在 main.js 載入完成後，移除載入畫面
                    setTimeout(() => {
                        const loadingContainer = document.getElementById("loading-container");
                        if (loadingContainer) {
                            loadingContainer.style.opacity = "0";
                            setTimeout(() => {
                                loadingContainer.parentNode.removeChild(loadingContainer);
                            }, 500);
                        }
                    }, 800);
                } catch (error) {
                    console.error("初始化過程中發生錯誤:", error);
                    // 顯示錯誤給使用者
                    const loadingContainer = document.getElementById("loading-container");
                    if (loadingContainer) {
                        loadingContainer.innerHTML =
                            '<div style="color: red; text-align: center; padding: 20px;">載入失敗，請重新整理頁面</div>';
                    }
                }
            })();
        </script>
        <script>
            window.pendingMessages = [];

            // 先行註冊全局的 message 監聽器，暫存所有消息
            window.addEventListener("message", function (event) {
                // 此處可以額外做一些基本的驗證（例如 event.origin 檢查），不過主要目的在於捕捉訊息
                window.pendingMessages.push(event);
            });
        </script>
        <script>
            // if (window.parent !== window) {
            //     console.log = function () {};
            // }
            // function loginAPIServer() {
            //     var iframe = document.createElement('iframe');
            //
            //     // Set the source URL of the iframe
            //     iframe.src = 'http://ava.ngrok.dev/api/index';
            //     // Set any other attributes of the iframe
            //     iframe.width = '0';
            //     iframe.height = '0';
            //     iframe.frameborder = '0';
            //
            //     // Add the iframe element to the parent element in the DOM tree
            //     setTimeout( function() {
            //         document.body.appendChild(iframe);
            //     }, 2000) ;
            // }
            // loginAPIServer();
        </script>
    </body>
</html>
